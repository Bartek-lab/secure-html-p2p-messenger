<!DOCTYPE html>
<html lang="en">
<head>‚àö
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Encrypted Messenger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .status {
            padding: 16px 24px;
            background: #f7f7f7;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #28a745;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .content {
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .setup-screen, .chat-screen {
            flex: 1;
            display: none;
            flex-direction: column;
        }

        .setup-screen.active, .chat-screen.active {
            display: flex;
        }

        .setup-content {
            padding: 32px;
            overflow-y: auto;
        }

        .step {
            margin-bottom: 32px;
        }

        .step h3 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .step p {
            color: #666;
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #5a6268;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
            min-height: 120px;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196f3;
            padding: 16px;
            border-radius: 4px;
            margin: 16px 0;
        }

        .info-box.success {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }

        .info-box.warning {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f9f9f9;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            max-width: 70%;
        }

        .message.sent {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message.received {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 16px;
            word-wrap: break-word;
            max-width: 100%;
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-bubble {
            background: white;
            border: 1px solid #e0e0e0;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            padding: 0 4px;
        }

        .input-area {
            padding: 16px 24px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
        }

        .input-area input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 24px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-area input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-area button {
            border-radius: 24px;
            padding: 12px 32px;
        }

        .system-message {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin: 16px 0;
            font-style: italic;
        }

        .copy-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .copy-indicator.show {
            opacity: 1;
        }

        .encryption-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .key-display {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            word-break: break-all;
            margin: 12px 0;
            border: 1px solid #e0e0e0;
        }

        @media (max-width: 768px) {
            .content {
                height: 500px;
            }

            .message {
                max-width: 85%;
            }

            .btn-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí P2P Encrypted Messenger</h1>
            <p>Serverless ‚Ä¢ End-to-End Encrypted ‚Ä¢ WebRTC</p>
        </div>

        <div class="status">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Disconnected</span>
            </div>
            <div class="encryption-badge">
                üîê AES-256
            </div>
        </div>

        <div class="content">
            <!-- Setup Screen -->
            <div class="setup-screen active" id="setupScreen">
                <div class="setup-content">
                    <div class="step">
                        <h3>Step 1: Choose Your Role</h3>
                        <p>One person creates an offer, the other accepts it.</p>
                        <div class="btn-group">
                            <button onclick="app.createOffer()">Create Offer (Person A)</button>
                            <button onclick="app.showAnswerInput()">Accept Offer (Person B)</button>
                        </div>
                    </div>

                    <div id="offerSection" style="display: none;">
                        <div class="step">
                            <h3>Step 2: Share Your Offer</h3>
                            <p>Copy this offer and send it to the other person (via email, chat, etc.)</p>
                            <textarea id="offerText" readonly></textarea>
                            <div class="btn-group" style="margin-top: 12px;">
                                <button onclick="app.copyOffer()">üìã Copy Offer</button>
                            </div>
                        </div>

                        <div class="step">
                            <h3>Step 3: Paste Their Answer</h3>
                            <p>When they send you their answer, paste it here:</p>
                            <textarea id="answerInput" placeholder="Paste answer here..."></textarea>
                            <div class="btn-group" style="margin-top: 12px;">
                                <button onclick="app.processAnswer()">‚úì Connect</button>
                            </div>
                        </div>
                    </div>

                    <div id="answerSection" style="display: none;">
                        <div class="step">
                            <h3>Step 2: Paste Their Offer</h3>
                            <p>Paste the offer you received:</p>
                            <textarea id="offerInput" placeholder="Paste offer here..."></textarea>
                            <div class="btn-group" style="margin-top: 12px;">
                                <button onclick="app.processOffer()">Generate Answer</button>
                            </div>
                        </div>

                        <div id="answerDisplay" style="display: none;">
                            <div class="step">
                                <h3>Step 3: Share Your Answer</h3>
                                <p>Copy this answer and send it back:</p>
                                <textarea id="answerText" readonly></textarea>
                                <div class="btn-group" style="margin-top: 12px;">
                                    <button onclick="app.copyAnswer()">üìã Copy Answer</button>
                                </div>
                                <div class="info-box success" style="margin-top: 16px;">
                                    <strong>Waiting for connection...</strong><br>
                                    The connection will establish automatically once they paste your answer.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="info-box warning">
                        <strong>üîí Privacy Note:</strong> All messages are end-to-end encrypted. This page creates a direct peer-to-peer connection between browsers. No server stores your messages.
                    </div>
                </div>
            </div>

            <!-- Chat Screen -->
            <div class="chat-screen" id="chatScreen">
                <div class="messages" id="messages">
                    <div class="system-message">üîí Secure connection established. Your messages are encrypted.</div>
                </div>
                <div class="input-area">
                    <input type="text" id="messageInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter') app.sendMessage()">
                    <button onclick="app.sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <div class="copy-indicator" id="copyIndicator">Copied to clipboard!</div>

    <script>
        const app = {
            peerConnection: null,
            dataChannel: null,
            isInitiator: false,
            encryptionKey: null,

            async init() {
                this.encryptionKey = await this.generateEncryptionKey();
            },

            async generateEncryptionKey() {
                return await crypto.subtle.generateKey(
                    { name: 'AES-GCM', length: 256 },
                    true,
                    ['encrypt', 'decrypt']
                );
            },

            async createOffer() {
                this.isInitiator = true;
                document.getElementById('offerSection').style.display = 'block';
                document.querySelectorAll('.step')[0].style.display = 'none';

                const offerTextArea = document.getElementById('offerText');
                offerTextArea.value = 'Generating offer... please wait...';

                const configuration = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                };

                this.peerConnection = new RTCPeerConnection(configuration);

                this.dataChannel = this.peerConnection.createDataChannel('chat');
                this.setupDataChannel();

                const offer = await this.peerConnection.createOffer();
                await this.peerConnection.setLocalDescription(offer);

                console.log('Offer created, gathering ICE candidates...');

                await new Promise((resolve) => {
                    if (this.peerConnection.iceGatheringState === 'complete') {
                        resolve();
                    } else {
                        const checkState = () => {
                            if (this.peerConnection.iceGatheringState === 'complete') {
                                this.peerConnection.removeEventListener('icegatheringstatechange', checkState);
                                resolve();
                            }
                        };
                        this.peerConnection.addEventListener('icegatheringstatechange', checkState);
                    }

                    setTimeout(() => {
                        console.log('ICE gathering timeout, proceeding anyway');
                        resolve();
                    }, 5000);
                });

                const keyData = await crypto.subtle.exportKey('raw', this.encryptionKey);
                const offerData = {
                    sdp: this.peerConnection.localDescription,
                    key: Array.from(new Uint8Array(keyData))
                };
                
                const offerString = btoa(JSON.stringify(offerData));
                offerTextArea.value = offerString;
                console.log('Offer ready:', offerString.substring(0, 50) + '...');
            },

            showAnswerInput() {
                document.getElementById('answerSection').style.display = 'block';
                document.querySelectorAll('.step')[0].style.display = 'none';
            },

            async processOffer() {
                const offerInput = document.getElementById('offerInput').value.trim();
                if (!offerInput) {
                    alert('Please paste the offer first');
                    return;
                }

                try {
                    const offerData = JSON.parse(atob(offerInput));
                    
                    // Import encryption key
                    this.encryptionKey = await crypto.subtle.importKey(
                        'raw',
                        new Uint8Array(offerData.key),
                        { name: 'AES-GCM', length: 256 },
                        true,
                        ['encrypt', 'decrypt']
                    );

                    const configuration = {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' }
                        ]
                    };

                    this.peerConnection = new RTCPeerConnection(configuration);

                    this.peerConnection.ondatachannel = (event) => {
                        this.dataChannel = event.channel;
                        this.setupDataChannel();
                    };

                    this.peerConnection.onicecandidate = (event) => {
                        if (event.candidate === null) {
                            const answer = this.peerConnection.localDescription;
                            document.getElementById('answerText').value = btoa(JSON.stringify(answer));
                            document.getElementById('answerDisplay').style.display = 'block';
                        }
                    };

                    await this.peerConnection.setRemoteDescription(new RTCSessionDescription(offerData.sdp));
                    const answer = await this.peerConnection.createAnswer();
                    await this.peerConnection.setLocalDescription(answer);

                } catch (error) {
                    console.error('Error processing offer:', error);
                    alert('Invalid offer format. Please check and try again.');
                }
            },

            async processAnswer() {
                const answerInput = document.getElementById('answerInput').value.trim();
                if (!answerInput) {
                    alert('Please paste the answer first');
                    return;
                }

                try {
                    const answer = JSON.parse(atob(answerInput));
                    await this.peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                } catch (error) {
                    console.error('Error processing answer:', error);
                    alert('Invalid answer format. Please check and try again.');
                }
            },

            setupDataChannel() {
                this.dataChannel.onopen = () => {
                    console.log('Data channel opened');
                    this.updateStatus(true);
                    document.getElementById('setupScreen').classList.remove('active');
                    document.getElementById('chatScreen').classList.add('active');
                    this.addSystemMessage('Connected successfully!');
                };

                this.dataChannel.onclose = () => {
                    console.log('Data channel closed');
                    this.updateStatus(false);
                    this.addSystemMessage('Connection closed');
                };

                this.dataChannel.onerror = (error) => {
                    console.error('Data channel error:', error);
                    this.addSystemMessage('Connection error occurred');
                };

                this.dataChannel.onmessage = async (event) => {
                    console.log('Message received:', event.data);
                    try {
                        const decrypted = await this.decrypt(event.data);
                        console.log('Decrypted message:', decrypted);
                        this.addMessage(decrypted, false);
                    } catch (error) {
                        console.error('Error decrypting message:', error);
                        this.addSystemMessage('Error decrypting message');
                    }
                };
            },

            async encrypt(text) {
                const encoder = new TextEncoder();
                const data = encoder.encode(text);
                const iv = crypto.getRandomValues(new Uint8Array(12));
                
                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    this.encryptionKey,
                    data
                );

                const combined = new Uint8Array(iv.length + encrypted.byteLength);
                combined.set(iv, 0);
                combined.set(new Uint8Array(encrypted), iv.length);
                
                return combined;
            },

            async decrypt(encryptedData) {
                let data;
                if (encryptedData instanceof Blob) {
                    const arrayBuffer = await encryptedData.arrayBuffer();
                    data = new Uint8Array(arrayBuffer);
                } else if (encryptedData instanceof ArrayBuffer) {
                    data = new Uint8Array(encryptedData);
                } else {
                    data = new Uint8Array(encryptedData);
                }
                
                const iv = data.slice(0, 12);
                const encrypted = data.slice(12);

                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    this.encryptionKey,
                    encrypted
                );

                const decoder = new TextDecoder();
                return decoder.decode(decrypted);
            },

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const message = input.value.trim();
                
                if (!message) return;
                if (!this.dataChannel || this.dataChannel.readyState !== 'open') {
                    alert('Not connected. Please establish connection first.');
                    return;
                }

                console.log('Sending message:', message);
                const encrypted = await this.encrypt(message);
                console.log('Encrypted message:', encrypted);
                this.dataChannel.send(encrypted);
                this.addMessage(message, true);
                input.value = '';
            },

            addMessage(text, isSent) {
                const messagesDiv = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = text;
                
                const time = document.createElement('div');
                time.className = 'message-time';
                time.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageDiv.appendChild(bubble);
                messageDiv.appendChild(time);
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            },

            addSystemMessage(text) {
                const messagesDiv = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'system-message';
                messageDiv.textContent = text;
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            },

            updateStatus(connected) {
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                if (connected) {
                    statusDot.classList.add('connected');
                    statusText.textContent = 'Connected & Encrypted';
                } else {
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'Disconnected';
                }
            },

            copyOffer() {
                const offerText = document.getElementById('offerText');
                offerText.select();
                document.execCommand('copy');
                this.showCopyIndicator();
            },

            copyAnswer() {
                const answerText = document.getElementById('answerText');
                answerText.select();
                document.execCommand('copy');
                this.showCopyIndicator();
            },

            showCopyIndicator() {
                const indicator = document.getElementById('copyIndicator');
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        };

      window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
